## Snapshot 2025-12-29T20:32:10+00:00

Ten snapshot dokumentuje faktyczny stan środowiska produkcyjnego
na hoście `tomaasz@ubuntuovh` po zakończeniu Stage 1.3
(modularny pipeline bez UI, potwierdzony runem).

============================================================

### systemd unit (AKTYWNA PRODUKCJA)

# /etc/systemd/system/gemini-ocr.service
[Unit]
StartLimitIntervalSec=300
StartLimitBurst=3
Description=Gemini OCR Pipeline (system service)
After=network-online.target
Wants=network-online.target

[Service]
SyslogIdentifier=gemini-ocr
Type=simple
User=tomaasz
Group=tomaasz

# UWAGA:
# systemd NADAL uruchamia STARE repo (ocr-gemini).
# Nowe repo (ocr-gemini-pipeline) NIE jest jeszcze podpięte do systemd.
WorkingDirectory=/home/tomaasz/projects/ocr-gemini

EnvironmentFile=/etc/default/gemini-ocr
Environment=PYTHONUNBUFFERED=1

StandardOutput=append:/var/log/gemini-ocr/gemini-ocr.log
StandardError=append:/var/log/gemini-ocr/gemini-ocr.err.log

ExecStart=/usr/local/bin/gemini-ocr-run.sh

Restart=on-failure
RestartSec=30s
TimeoutStopSec=30s
KillSignal=SIGINT

[Install]
WantedBy=multi-user.target

============================================================

### env file (ŹRÓDŁO PRAWDY)

# /etc/default/gemini-ocr

# --- Python ---
PYTHON_EXEC=/home/tomaasz/projects/ocr-gemini/.venv/bin/python
SCRIPT_FILE=/home/tomaasz/projects/ocr-gemini/gemini_ocr.py

# --- OCR ---
OCR_ROOT="/home/tomaasz/mnt/nas_genealogy/Sources/Nurskie dokumenty/"
OCR_OUT_ROOT=/home/tomaasz/ocr_out
OCR_PROMPT_ID=agad_generic
OCR_PROFILE_DIR=/home/tomaasz/.pw_gemini_profile
OCR_RECURSIVE=1
OCR_LIMIT=5

# --- DB (Docker Postgres) ---
PGHOST=127.0.0.1
PGPORT=5432
PGDATABASE=genealogy
PGUSER=tomaasz

============================================================

### Python runtime (POTWIERDZONE)

Venv:
  /home/tomaasz/projects/ocr-gemini/.venv

Python:
  Python 3.12.3

Playwright:
  import playwright -> OK

============================================================

### wrapper location (PRODUKCJA)

-rwxr-xr-x 1 root root 1028 Dec 29 18:24
/usr/local/bin/gemini-ocr-run.sh

============================================================

### repozytoria (FAKTYCZNY STAN)

~/projects/
├── ocr-gemini
│   └── AKTYWNA PRODUKCJA (systemd)
│
└── ocr-gemini-pipeline
    └── NOWE REPO MODULARNE
        - zainstalowane w venv jako editable:
          pip install -e .
        - uruchamiane MANUALNIE
        - NIE podpięte do systemd

============================================================

### Stage 1.3 — POTWIERDZONY RUN (NOWE REPO)

Komenda:
  set -a; source /etc/default/gemini-ocr; set +a
  OCR_LIMIT=1 \
  /home/tomaasz/projects/ocr-gemini/.venv/bin/python \
    -m ocr_gemini.pipeline

Wynik:
  OK: <plik> -> doc_id=1 entry_id=1 out=<OCR_OUT_ROOT>/...
  {"processed": 1}

Efekty:
- zapis katalogu wynikowego w OCR_OUT_ROOT
- wpis w genealogy.ocr_document
- wpis w genealogy.ocr_entry
- placeholder OCR (Stage 1.3: no UI)

============================================================

### Status końcowy snapshotu

- Produkcja: STARE repo (ocr-gemini) — działa
- Nowe repo: ocr-gemini-pipeline
  - Stage 1–1.3 DONE
  - gotowe do integracji UI (Stage 2)
  - NIE podpięte do systemd (świadoma decyzja)

============================================================
